var MILES_TO_METERS=1609;var cars={volt:{range:37},spark:{range:82},tango:{range:200},fiat:{range:87},karma:{range:230},focus:{range:76},cmax:{range:21},fusion:{range:21},fit:{range:82},mitsubishi:{range:62},leaf:{range:75},smart:{range:68},smith:{range:100},models_short:{range:208},models_long:{range:265},roadster:{range:244},rav4:{range:100},prius:{range:15},wheego:{range:100}};var directionsService=new google.maps.DirectionsService();var directionsDisplay;var map;var waypoints=[];var stationStops=[];var markers=[];var stationMarkers=[];var infoWindows=[];var range=null;var stations=[];var importedStations=false;var clicks=0;$(window).load(function(){directionsDisplay=new google.maps.DirectionsRenderer;mapLoad();scriptImport("/js/all_stations-min.js");directionsDisplay.setMap(map);directionsDisplay.setPanel($("#panel")[0]);directionsDisplay.setOptions({suppressInfoWindows:true,suppressMarkers:false,markerOptions:{clickable:true,zIndex:2}});google.maps.event.addListener(map,"click",function(a){setOriginDestination(a.latLng.toUrlValue())});$("#options-link").click(function(a){if(importedStations===false){scriptImport("/js/fast_stations-min.js");scriptImport("/js/j1772_stations-min.js");scriptImport("/js/slow_stations-min.js");scriptImport("/js/other_stations-min.js");importedStations=true}});$("#getroute").click(function(a){mapsQuery()})});function mapLoad(){var a=new google.maps.LatLng(39.828182,-98.579144);var b={zoom:4,center:a};map=new google.maps.Map($("#map-canvas")[0],b)}function setOriginDestination(a){if(clicks%2==0){$("#origin").val(a)}else{$("#destination").val(a)}clicks++}function mapsQuery(){stations=[];for(var c=0,f=stationMarkers.length;c<f;c++){stationMarkers[c].setMap(null)}stationMarkers=[];for(var c=0,f=infoWindows.length;c<f;c++){infoWindows[c].close()}infoWindows=[];directionsDisplay.setDirections({routes:[]});waypoints=[];stationStops=[];markers=[];$("#warning").html("");$("#warning").removeClass("shadow warning-container");if($("#dcfast")[0].checked&&$("#j1772")[0].checked&&$("#slow")[0].checked&&$("#other")[0].checked){stations=ALL_STATIONS}else{stations=($("#dcfast")[0].checked)?FAST_STATIONS:[];stations=($("#j1772")[0].checked)?stations.concat(J1772_STATIONS):stations;stations=($("#slow")[0].checked)?stations.concat(SLOW_STATIONS):stations;stations=($("#other")[0].checked)?stations.concat(OTHER_STATIONS):stations}if(stations.length==0){alert("You must include at least one charger type in your search.")}for(var c=0,f=stations.length;c<f;c++){var b=new google.maps.LatLng(stations[c].lat,stations[c].lng);var d="http://labs.google.com/ridefinder/images/mm_20_orange.png";var e=stations[c].station_name+", "+stations[c].street_address;var a=new google.maps.Marker({position:b,icon:d,title:e,map:map,zIndex:1});stationMarkers.push(a)}if($("#range")[0].value&&($("#range")[0].value>0)){range=$("#range")[0].value*MILES_TO_METERS}else{if($("#cars")[0].value){range=cars[$("#cars")[0].value].range*MILES_TO_METERS}else{alert("You must provide either a car type or an estimated range.");return}}if($("#origin")[0].value&&$("#destination")[0].value){origin=$("#origin")[0].value;destination=$("#destination")[0].value}else{alert("You must provide an origin and a destination.");return}originalRequest={origin:origin,destination:destination,travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL};directionsCalc()}function directionsCalc(){directionsService.route(originalRequest,function(a,b){if(b==google.maps.DirectionsStatus.OK){if(a.routes[0].legs[0].distance.value>range){createWaypoints(a);newRequest={origin:origin,destination:destination,travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL,waypoints:waypoints};directionsService.route(newRequest,function(c,d){additionalPass(c,d)})}else{warnLong(a);directionsDisplay.setDirections(a)}}else{handleErrors(b)}})}function createWaypoints(a){var g=new google.maps.Polyline({path:a.routes[0].overview_path});var e=g.GetPointsAtDistance(0.85*range);for(var c=0,h=e.length;c<h;c++){var f=getClosestStation(e[c]);var d={location:f.latlng,stopover:true};waypoints.push(d);stationStops.push(f);var b=new google.maps.Marker({position:f.latlng,map:map,icon:"img/invisible.png",zIndex:3});markers.push(b)}}function getClosestStation(a){var c=[];var g=-1;var f=null;for(var e=0,j=stations.length;e<j;e++){f=new google.maps.LatLng(stations[e].lat,stations[e].lng);var h=google.maps.geometry.spherical.computeDistanceBetween(a,f);c.push(h);if(g==-1||h<c[g]){g=e}}var b=new google.maps.LatLng(stations[g].lat,stations[g].lng);return{station:stations[g],latlng:b}}function additionalPass(v,g){if(g==google.maps.DirectionsStatus.OK){var p=false;for(var o=0,b=v.routes[0].legs.length;o<b;o++){var r=v.routes[0].legs[o].distance.value;if(r>range){var s=new google.maps.Polyline({path:[]});for(var f=0,c=v.routes[0].legs[o].steps.length;f<c;f++){for(var e=0,d=v.routes[0].legs[o].steps[f].path.length;e<d;e++){s.getPath().push(v.routes[0].legs[o].steps[f].path[e])}}var q=s.GetPointAtDistance(0.75*range);var u=getClosestStation(q);var a={location:u.latlng,stopover:true};waypoints.push(a);stationStops.push(u);var h=new google.maps.Marker({position:stationStops[o].latlng,map:map,icon:"img/invisible.png",zIndex:3});markers.push(h);p=true}}if(p==true){var t={origin:origin,destination:destination,travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL,waypoints:waypoints,optimizeWaypoints:true};directionsService.route(t,function(i,j){additionalPass(i,j)})}else{warnLong(v);createInfoWindows();directionsDisplay.setDirections(v)}}else{handleErrors(g)}}function createInfoWindows(){for(var b=0,g=stationStops.length;b<g;b++){var c=(stationStops[b].station.ev_network==null)?"--":stationStops[b].station.ev_network;var a=(stationStops[b].station.intersection_directions==null)?"No specific directions available.":stationStops[b].station.intersection_directions;var f=(stationStops[b].station.ev_dc_fast_num)?"DC Fast":"";f=(stationStops[b].station.ev_level2_evse_num)?f.concat(" J1772"):f;f=(stationStops[b].station.ev_level1_evse_num)?f.concat(" 110V"):f;f=(stationStops[b].station.ev_other_evse)?f.concat(" "+stationStops[b].station.ev_other_evse):f;var e='<div class="info-window"><h1 class="info-header">'+stationStops[b].station.station_name+"</h1><strong>Open:</strong> "+stationStops[b].station.access_days_time+"</br><strong>Use info:</strong> "+stationStops[b].station.groups_with_access_code+"</br><strong>Network:</strong> "+c+"</br><strong>Charger types:</strong> "+f+"</br><strong>Find it:</strong> "+a+"</br></div>";var d=new google.maps.InfoWindow({content:e,maxWidth:250,pixelOffset:new google.maps.Size(0,0)});infoWindows.push(d)}for(var b=0,g=markers.length;b<g;b++){google.maps.event.addListener(markers[b],"click",(function(h){return function(){infoWindows[h].open(map,markers[h])}})(b))}}function warnLong(d){var b=false;$("#warning").addClass("shadow warning-container");for(var a=0,c=d.routes[0].legs.length;a<c;a++){if(d.routes[0].legs[a].distance.value>0.85*range){b=true}}if(b==true){$("#warning").html("Using a range of "+Math.round(range/MILES_TO_METERS)+' mi, there is at least one leg of this trip longer than 85% of your range. If you don\'t want to cut it that close, you can <a href="javascript:void(0)" onclick="recalculate();">recalculate</a>.')}else{$("#warning").html("Using a range of "+Math.round(range/MILES_TO_METERS)+" mi.")}}function recalculate(){$("#warning").html("");$("#warning").removeClass("shadow warning-container");waypoints=[];stationStops=[];markers=[];infoWindows=[];range=0.85*range;directionsCalc()}function handleErrors(a){$("#warning").addClass("shadow warning-container");$("#warning").html("We're sorry, we couldn't process your request. It returned an error code of "+a+".")}google.maps.LatLng.prototype.distanceFrom=function(f){var e=6378137;var h=this.lat();var j=this.lng();var g=f.lat();var i=f.lng();var l=(g-h)*Math.PI/180;var b=(i-j)*Math.PI/180;var n=Math.sin(l/2)*Math.sin(l/2)+Math.cos(h*Math.PI/180)*Math.cos(g*Math.PI/180)*Math.sin(b/2)*Math.sin(b/2);var m=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n));var k=e*m;return k};google.maps.LatLng.prototype.latRadians=function(){return this.lat()*Math.PI/180};google.maps.LatLng.prototype.lngRadians=function(){return this.lng()*Math.PI/180};google.maps.Polygon.prototype.Contains=function(b){var c=0;var e=false;var a=b.lng();var f=b.lat();for(var d=0;d<this.getPath().getLength();d++){c++;if(c==this.getPath().getLength()){c=0}if(((this.getPath().getAt(d).lat()<f)&&(this.getPath().getAt(c).lat()>=f))||((this.getPath().getAt(c).lat()<f)&&(this.getPath().getAt(d).lat()>=f))){if(this.getPath().getAt(d).lng()+(f-this.getPath().getAt(d).lat())/(this.getPath().getAt(c).lat()-this.getPath().getAt(d).lat())*(this.getPath().getAt(c).lng()-this.getPath().getAt(d).lng())<a){e=!e}}}return e};google.maps.Polygon.prototype.Area=function(){var m=0;var f=0;var k=this.Bounds();var e=k.getSouthWest().lng();var n=k.getSouthWest().lat();for(var g=0;g<this.getPath().getLength();g++){f++;if(f==this.getPath().getLength()){f=0}var d=this.getPath().getAt(g).distanceFrom(new google.maps.LatLng(this.getPath().getAt(g).lat(),e));var c=this.getPath().getAt(f).distanceFrom(new google.maps.LatLng(this.getPath().getAt(f).lat(),e));var l=this.getPath().getAt(g).distanceFrom(new google.maps.LatLng(n,this.getPath().getAt(g).lng()));var h=this.getPath().getAt(f).distanceFrom(new google.maps.LatLng(n,this.getPath().getAt(f).lng()));m+=d*h-c*l}return Math.abs(m*0.5)};google.maps.Polygon.prototype.Distance=function(){var b=0;for(var a=1;a<this.getPath().getLength();a++){b+=this.getPath().getAt(a).distanceFrom(this.getPath().getAt(a-1))}return b};google.maps.Polygon.prototype.Bounds=function(){var b=new google.maps.LatLngBounds();for(var a=0;a<this.getPath().getLength();a++){b.extend(this.getPath().getAt(a))}return b};google.maps.Polygon.prototype.GetPointAtDistance=function(b){if(b==0){return this.getPath().getAt(0)}if(b<0){return null}if(this.getPath().getLength()<2){return null}var g=0;var c=0;for(var d=1;(d<this.getPath().getLength()&&g<b);d++){c=g;g+=this.getPath().getAt(d).distanceFrom(this.getPath().getAt(d-1))}if(g<b){return null}var f=this.getPath().getAt(d-2);var e=this.getPath().getAt(d-1);var a=(b-c)/(g-c);return new google.maps.LatLng(f.lat()+(e.lat()-f.lat())*a,f.lng()+(e.lng()-f.lng())*a)};google.maps.Polygon.prototype.GetPointsAtDistance=function(a){var e=a;var h=[];if(a<=0){return h}var f=0;var c=0;for(var d=1;(d<this.getPath().getLength());d++){c=f;f+=this.getPath().getAt(d).distanceFrom(this.getPath().getAt(d-1));while(f>e){var j=this.getPath().getAt(d-1);var g=this.getPath().getAt(d);var b=(e-c)/(f-c);h.push(new google.maps.LatLng(j.lat()+(g.lat()-j.lat())*b,j.lng()+(g.lng()-j.lng())*b));e+=a}}return h};google.maps.Polygon.prototype.GetIndexAtDistance=function(a){if(a==0){return this.getPath().getAt(0)}if(a<0){return null}var d=0;var b=0;for(var c=1;(c<this.getPath().getLength()&&d<a);c++){b=d;d+=this.getPath().getAt(c).distanceFrom(this.getPath().getAt(c-1))}if(d<a){return null}return c};google.maps.Polygon.prototype.Bearing=function(g,f){if(g==null){g=0;f=this.getPath().getLength()-1}else{if(f==null){f=g+1}}if((g<0)||(g>=this.getPath().getLength())||(f<0)||(f>=this.getPath().getLength())){return}var h=this.getPath().getAt(g);var i=this.getPath().getAt(f);if(h.equals(i)){return 0}var c=h.latRadians();var e=h.lngRadians();var b=i.latRadians();var d=i.lngRadians();var a=-Math.atan2(Math.sin(e-d)*Math.cos(b),Math.cos(c)*Math.sin(b)-Math.sin(c)*Math.cos(b)*Math.cos(e-d));if(a<0){a+=Math.PI*2}a=a*180/Math.PI;return parseFloat(a.toFixed(1))};google.maps.Polyline.prototype.Contains=google.maps.Polygon.prototype.Contains;google.maps.Polyline.prototype.Area=google.maps.Polygon.prototype.Area;google.maps.Polyline.prototype.Distance=google.maps.Polygon.prototype.Distance;google.maps.Polyline.prototype.Bounds=google.maps.Polygon.prototype.Bounds;google.maps.Polyline.prototype.GetPointAtDistance=google.maps.Polygon.prototype.GetPointAtDistance;google.maps.Polyline.prototype.GetPointsAtDistance=google.maps.Polygon.prototype.GetPointsAtDistance;google.maps.Polyline.prototype.GetIndexAtDistance=google.maps.Polygon.prototype.GetIndexAtDistance;google.maps.Polyline.prototype.Bearing=google.maps.Polygon.prototype.Bearing;function scriptImport(b){var a=document.createElement("script");a.setAttribute("src",b);a.setAttribute("type","text/javascript");document.getElementsByTagName("head")[0].appendChild(a)};